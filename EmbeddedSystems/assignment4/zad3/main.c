#include <avr/io.h>
#include <stdio.h>
#include <stdlib.h>
#include <util/delay.h>

void
setup( void ) {
    UCSR0B &= ~_BV(RXEN0) & ~_BV(TXEN0);

    DDRD = DDRB = 0xff;

    // Timer0
    TCCR0A =  _BV( COM0A1 ) | _BV( COM0A0 );
    TCCR0A |= _BV( COM0B1 ) | _BV( COM0B0 );
    TCCR0A |= _BV( WGM01 ) | _BV( WGM00 );

    TCCR0B = _BV( CS02 );

    // Timer 1
    TCCR1A =  _BV( COM1A1 ) | _BV( COM1A0 );
    TCCR1A |= _BV( WGM10 );

    TCCR1B = _BV( WGM12 );
    TCCR1B = _BV( CS12 );

    srand( __TIME__[ 7 ] | (uint32_t) __TIME__[ 6 ] << 8 | (uint32_t) __TIME__[ 4 ] << 16 | (uint32_t) __TIME__[ 3 ] << 24 );
}

uint8_t table[][ 3 ] = {
    { 255, 63, 63 },
    { 254, 58, 69 },
    { 254, 53, 74 },
    { 253, 48, 80 },
    { 252, 43, 86 },
    { 251, 38, 92 },
    { 249, 34, 98 },
    { 247, 30, 104 },
    { 245, 26, 111 },
    { 242, 22, 117 },
    { 239, 19, 123 },
    { 236, 15, 129 },
    { 233, 13, 136 },
    { 229, 10, 142 },
    { 225, 8, 148 },
    { 221, 5, 154 },
    { 217, 4, 160 },
    { 212, 2, 166 },
    { 208, 1, 172 },
    { 203, 0, 178 },
    { 197, 0, 184 },
    { 192, 0, 189 },
    { 187, 0, 195 },
    { 181, 0, 200 },
    { 175, 1, 205 },
    { 169, 2, 210 },
    { 163, 3, 215 },
    { 157, 5, 219 },
    { 151, 6, 223 },
    { 145, 9, 227 },
    { 139, 11, 231 },
    { 132, 14, 235 },
    { 126, 17, 238 },
    { 120, 20, 241 },
    { 114, 24, 243 },
    { 107, 28, 246 },
    { 101, 32, 248 },
    { 95, 36, 250 },
    { 89, 41, 251 },
    { 83, 45, 253 },
    { 77, 50, 254 },
    { 72, 55, 254 },
    { 66, 61, 254 },
    { 61, 66, 254 },
    { 55, 72, 254 },
    { 50, 77, 254 },
    { 45, 83, 253 },
    { 41, 89, 251 },
    { 36, 95, 250 },
    { 32, 101, 248 },
    { 28, 107, 246 },
    { 24, 114, 243 },
    { 20, 120, 241 },
    { 17, 126, 238 },
    { 14, 132, 235 },
    { 11, 139, 231 },
    { 9, 145, 227 },
    { 6, 151, 223 },
    { 5, 157, 219 },
    { 3, 163, 215 },
    { 2, 169, 210 },
    { 1, 175, 205 },
    { 0, 181, 200 },
    { 0, 187, 195 },
    { 0, 192, 189 },
    { 0, 197, 184 },
    { 0, 203, 178 },
    { 1, 208, 172 },
    { 2, 212, 166 },
    { 4, 217, 160 },
    { 5, 221, 154 },
    { 8, 225, 148 },
    { 10, 229, 142 },
    { 13, 233, 136 },
    { 15, 236, 129 },
    { 19, 239, 123 },
    { 22, 242, 117 },
    { 26, 245, 111 },
    { 30, 247, 104 },
    { 34, 249, 98 },
    { 38, 251, 92 },
    { 43, 252, 86 },
    { 48, 253, 80 },
    { 53, 254, 74 },
    { 58, 254, 69 },
    { 63, 255, 63 },
    { 69, 254, 58 },
    { 74, 254, 53 },
    { 80, 253, 48 },
    { 86, 252, 43 },
    { 92, 251, 38 },
    { 98, 249, 34 },
    { 104, 247, 30 },
    { 111, 245, 26 },
    { 117, 242, 22 },
    { 123, 239, 19 },
    { 129, 236, 15 },
    { 136, 233, 13 },
    { 142, 229, 10 },
    { 148, 225, 8 },
    { 154, 221, 5 },
    { 160, 217, 4 },
    { 166, 212, 2 },
    { 172, 208, 1 },
    { 178, 203, 0 },
    { 184, 197, 0 },
    { 189, 192, 0 },
    { 195, 187, 0 },
    { 200, 181, 0 },
    { 205, 175, 1 },
    { 210, 169, 2 },
    { 215, 163, 3 },
    { 219, 157, 5 },
    { 223, 151, 6 },
    { 227, 145, 9 },
    { 231, 139, 11 },
    { 235, 132, 14 },
    { 238, 126, 17 },
    { 241, 120, 20 },
    { 243, 114, 24 },
    { 246, 107, 28 },
    { 248, 101, 32 },
    { 250, 95, 36 },
    { 251, 89, 41 },
    { 253, 83, 45 },
    { 254, 77, 50 },
    { 254, 72, 55 },
    { 254, 66, 61 },
    { 254, 61, 66 },
    { 254, 55, 72 },
    { 254, 50, 77 },
    { 253, 45, 83 },
    { 251, 41, 89 },
    { 250, 36, 95 },
    { 248, 32, 101 },
    { 246, 28, 107 },
    { 243, 24, 114 },
    { 241, 20, 120 },
    { 238, 17, 126 },
    { 235, 14, 132 },
    { 231, 11, 139 },
    { 227, 9, 145 },
    { 223, 6, 151 },
    { 219, 5, 157 },
    { 215, 3, 163 },
    { 210, 2, 169 },
    { 205, 1, 175 },
    { 200, 0, 181 },
    { 195, 0, 187 },
    { 189, 0, 192 },
    { 184, 0, 197 },
    { 178, 0, 203 },
    { 172, 1, 208 },
    { 166, 2, 212 },
    { 160, 4, 217 },
    { 154, 5, 221 },
    { 148, 8, 225 },
    { 142, 10, 229 },
    { 136, 13, 233 },
    { 129, 15, 236 },
    { 123, 19, 239 },
    { 117, 22, 242 },
    { 111, 26, 245 },
    { 104, 30, 247 },
    { 98, 34, 249 },
    { 92, 38, 251 },
    { 86, 43, 252 },
    { 80, 48, 253 },
    { 74, 53, 254 },
    { 69, 58, 254 },
    { 63, 63, 255 },
    { 58, 69, 254 },
    { 53, 74, 254 },
    { 48, 80, 253 },
    { 43, 86, 252 },
    { 38, 92, 251 },
    { 34, 98, 249 },
    { 30, 104, 247 },
    { 26, 111, 245 },
    { 22, 117, 242 },
    { 19, 123, 239 },
    { 15, 129, 236 },
    { 13, 136, 233 },
    { 10, 142, 229 },
    { 8, 148, 225 },
    { 5, 154, 221 },
    { 4, 160, 217 },
    { 2, 166, 212 },
    { 1, 172, 208 },
    { 0, 178, 203 },
    { 0, 184, 197 },
    { 0, 189, 192 },
    { 0, 195, 187 },
    { 0, 200, 181 },
    { 1, 205, 175 },
    { 2, 210, 169 },
    { 3, 215, 163 },
    { 5, 219, 157 },
    { 6, 223, 151 },
    { 9, 227, 145 },
    { 11, 231, 139 },
    { 14, 235, 132 },
    { 17, 238, 126 },
    { 20, 241, 120 },
    { 24, 243, 114 },
    { 28, 246, 107 },
    { 32, 248, 101 },
    { 36, 250, 95 },
    { 41, 251, 89 },
    { 45, 253, 83 },
    { 50, 254, 77 },
    { 55, 254, 72 },
    { 61, 254, 66 },
    { 66, 254, 61 },
    { 72, 254, 55 },
    { 77, 254, 50 },
    { 83, 253, 45 },
    { 89, 251, 41 },
    { 95, 250, 36 },
    { 101, 248, 32 },
    { 107, 246, 28 },
    { 114, 243, 24 },
    { 120, 241, 20 },
    { 126, 238, 17 },
    { 132, 235, 14 },
    { 139, 231, 11 },
    { 145, 227, 9 },
    { 151, 223, 6 },
    { 157, 219, 5 },
    { 163, 215, 3 },
    { 169, 210, 2 },
    { 175, 205, 1 },
    { 181, 200, 0 },
    { 187, 195, 0 },
    { 192, 189, 0 },
    { 197, 184, 0 },
    { 203, 178, 0 },
    { 208, 172, 1 },
    { 212, 166, 2 },
    { 217, 160, 4 },
    { 221, 154, 5 },
    { 225, 148, 8 },
    { 229, 142, 10 },
    { 233, 136, 13 },
    { 236, 129, 15 },
    { 239, 123, 19 },
    { 242, 117, 22 },
    { 245, 111, 26 },
    { 247, 104, 30 },
    { 249, 98, 34 },
    { 251, 92, 38 },
    { 252, 86, 43 },
    { 253, 80, 48 },
    { 254, 74, 53 },
    { 254, 69, 58 },
    { 255, 63, 63 }
};

int
main( void ) {
    setup();

    uint8_t i = rand();
    int8_t dim = 0;
    uint8_t flag = 0;

    for( ;; ) {
        OCR0A = table[ i ][ 0 ] >> dim;
        OCR0B = table[ i ][ 1 ] >> dim;
        OCR1A = table[ i ][ 2 ] >> dim;

        if( flag ) {
            if( ++ dim > 7 ) {
                dim = 7;
                i = rand();
                flag = !flag;
            }
        } else {
            if( -- dim < 0 ) {
                dim = 0;
                flag = !flag;
            }
        }

        _delay_ms( 50 );
    }

    return 0;
}
